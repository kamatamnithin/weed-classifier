name: Build and push Docker images

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:       # <- add this
    inputs:
      reason:
        description: 'Optional trigger reason'
        required: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      REGISTRY: ghcr.io
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.frontend
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/weed-frontend:latest
            ghcr.io/${{ github.repository_owner }}/weed-frontend:${{ github.sha }}
          build-args: |
            VITE_API_URL=http://backend:8000

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./ml_backend
          file: Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/weed-backend:latest
            ghcr.io/${{ github.repository_owner }}/weed-backend:${{ github.sha }}

      - name: Output image locations
        run: |
          echo "Frontend image: ghcr.io/${{ github.repository_owner }}/weed-frontend:${{ github.sha }}"
          echo "Backend image: ghcr.io/${{ github.repository_owner }}/weed-backend:${{ github.sha }}"

      - name: Smoke test backend image
        run: |
          echo "Starting backend container for smoke test..."
          docker run -d --name weed-backend-test -p 8002:8000 ghcr.io/${{ github.repository_owner }}/weed-backend:${{ github.sha }}
          echo "Waiting for service to start..."
          sleep 6
          echo "Health check:"
          curl -f http://localhost:8002/health
          echo "Stopping test container"
          docker kill weed-backend-test || true

      - name: Optional: Trigger Render deployments (frontend & backend)
        if: ${{ (secrets.RENDER_FRONTEND_SERVICE_ID && secrets.RENDER_API_KEY) || (secrets.RENDER_BACKEND_SERVICE_ID && secrets.RENDER_API_KEY) }}
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          set -e
          if [ ! -z "${{ secrets.RENDER_FRONTEND_SERVICE_ID }}" ]; then
            echo "Triggering Render deployment for frontend service ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}"
            curl -s -X POST "https://api.render.com/deploy/srv-${{ secrets.RENDER_FRONTEND_SERVICE_ID }}" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" -H "Content-Type: application/json" \
              -d '{"clearCache":true}'
            echo "Triggered frontend deploy"
          fi
          if [ ! -z "${{ secrets.RENDER_BACKEND_SERVICE_ID }}" ]; then
            echo "Triggering Render deployment for backend service ${{ secrets.RENDER_BACKEND_SERVICE_ID }}"
            curl -s -X POST "https://api.render.com/deploy/srv-${{ secrets.RENDER_BACKEND_SERVICE_ID }}" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" -H "Content-Type: application/json" \
              -d '{"clearCache":true}'
            echo "Triggered backend deploy"
          fi
          echo "Triggered Render deployments (check Render dashboard for status)"
